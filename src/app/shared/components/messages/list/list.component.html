@if (dataSource) {
<div class="chat-container">
    <div class="pull-to-load-indicator top"
        [class.active]="isPulling && pullToLoadProgress > 0 && scrollViewport.measureScrollOffset('top') < 5">
        <div class="progress-circle" [style.transform]="'rotate(' + (pullToLoadProgress * 3.6) + 'deg)'"></div>
        <div class="pull-text">{{ pullToLoadProgress >= 100 ? 'é‡Šæ”¾åŠ è½½å†å²æ¶ˆæ¯' : 'ä¸‹æ‹‰åŠ è½½å†å²æ¶ˆæ¯' }}</div>
    </div>
    @if (dataSource.isLoadingHistory) {
    <div class="loading-indicator top">
        <div class="spinner"></div>
        <div>åŠ è½½æ—©æœŸæ¶ˆæ¯...</div>
    </div>
    }

    <cdk-virtual-scroll-viewport autoSize class="messages-container" #cdkScrollViewport>
        @if (!dataSource.isLoadingHistory && dataSource.hasMoreHistory) {
        <div class="load-more-container">
            <button class="load-more-btn" (click)="loadOlderMessages()">åŠ è½½æ—©æœŸæ¶ˆæ¯</button>
        </div>
        }

        <ng-container *cdkVirtualFor="let message of dataSource.messages; trackBy: trackByMessageId">
            <div class="chat-message-item" [class.my-message]="message.isMyMessage"
                [class.other-message]="!message.isMyMessage">

                <div class="message-container">
                    @if (!message.isMyMessage) {
                    <deepin-avatar [avatarUrl]="message.from.id | fileUrl"></deepin-avatar>
                    }
                    <div class="message-content">
                        @if (!message.isMyMessage) {
                        <div class="message-sender">
                            {{ message.from.displayName }}
                        </div>
                        }
                        @if(message.content) {
                        <div class="message-text">
                            {{ message.content }}
                            @if(message.isEdited){
                            <span class="edited-indicator">(å·²ç¼–è¾‘)</span>
                            }
                        </div>
                        }

                        <div class="message-timestamp">
                            {{ message.createdAt | formatTime }}
                            @if(message.isMyMessage && message.isRead){
                            <span class="read-status">âœ“</span>
                            }
                        </div>
                        <!-- 
                        <div class="reactions" *ngIf="message.reactions && getReactionCount(message.reactions) > 0">
                            <div *ngFor="let reaction of getReactionEntries(message.reactions)" class="reaction-badge">
                                <span class="reaction-emoji">{{ reaction.emoji }}</span>
                                <span class="reaction-count">{{ reaction.count }}</span>
                            </div>
                        </div> -->
                    </div>
                </div>

                <!-- <div class="message-actions">
                    <button class="action-btn" (click)="replyTo(message)" title="å›å¤">â†©ï¸</button>
                    <button class="action-btn" (click)="toggleEmojiPicker(message.id)" title="æ·»åŠ ååº”">ğŸ˜€</button>
                    <button class="action-btn" *ngIf="isMyMessage(message)" (click)="editMessage(message)"
                        title="ç¼–è¾‘">âœï¸</button>
                    <button class="action-btn" *ngIf="isMyMessage(message)" (click)="deleteMessage(message)"
                        title="åˆ é™¤">ğŸ—‘ï¸</button>
                </div> -->
            </div>
        </ng-container>
    </cdk-virtual-scroll-viewport>

    <div class="pull-to-load-indicator bottom"
        [class.active]="isPulling && pullToLoadProgress > 0 && scrollViewport.measureScrollOffset('bottom') < 5">
        <div class="progress-circle" [style.transform]="'rotate(' + (pullToLoadProgress * 3.6) + 'deg)'"></div>
        <div class="pull-text">{{ pullToLoadProgress >= 100 ? 'é‡Šæ”¾åŠ è½½æ–°æ¶ˆæ¯' : 'ä¸Šæ‹‰åŠ è½½æ–°æ¶ˆæ¯' }}</div>
    </div>

    @if (dataSource.isLoadingNewer) {
    <div class="loading-indicator bottom">
        <div class="spinner"></div>
        <div>åŠ è½½æ–°æ¶ˆæ¯...</div>
    </div>
    }
</div>
}